#!/usr/bin/env bash

# shellcheck disable=SC2004,SC1090

source "$CLI_DIR/tc/framework/functions"
source "$CLI_DIR/tc/app/aws/functions"

while [[ $# -gt 0 ]]
do
key="$1"

case $key in
    --db-master-name)
    DB_MASTER_NAME="$2"
    shift 2
    ;;
    --db-instance-type)
    DB_INSTANCE_TYPE="$2"
    shift 2
    ;;
    --replicas-count)
    REPLICA_DB_INSTANCES_COUNT="$2"
    shift 2
    ;;
    *)
    ;;
esac
done

function create_master_replicas() {
  __db_master_name=$1
  __db_instance_type=$2
  __replica_db_instances_count=$3
  for (( i = 1; i <= $__replica_db_instances_count; i++ )); do
    if [[ $i = "1" ]]; then
      __db_replica_name=${__db_master_name}-replica-$(date +%Y%m%d-%H%M%S)
      __output=$( aws rds create-db-instance-read-replica \
              --db-instance-identifier "$__db_replica_name" \
              --source-db-instance-identifier "$__db_master_name" \
              --db-instance-class "$__db_instance_type" )
      _error_code=$?
      if [ $_error_code -gt "0" ]; then
        __MSG="Error, when create replica"
      fi

      # Change DB slave host in .env file
      __db_host=$(grep "^DB_HOST=" .env | awk -F '=' '{print $2}')
      if [[ $__db_host != *".rds.amazonaws.com" ]]; then
        __db_host=$( dig cname "$__db_host" +short )
        __error_code=$?
        if [ $_error_code -gt "0" ]; then
          __MSG+="Error when get cname"
          _error_code=$(( "$_error_code" + "$__error_code" ))
        fi
      fi
      __db_host_suffix=$( echo "$__db_host" | awk -F'.' '{ print $2"."$3"."$4"."$5"."$6 }' )
      sed -i "s/DB_SLAVE_HOST=.*/\# DB_SLAVE_HOST=${__db_replica_name}.${__db_host_suffix}/g" .env
      __error_code=$?
      if [ $_error_code -gt "0" ]; then
        __MSG+="Error when get cname"
        _error_code=$(( "$_error_code" + "$__error_code" ))
      fi

      __MSG="Command: tcctl aws create read replica $__db_replica_name"
      __MSG+="$__output"
      if [ $_error_code -eq "0" ]; then
        _message "$__MSG"
      else
        _message "$__MSG" "error" "$_error_code"
      fi
    fi
    if [[ $i = "2" ]]; then
      __db_backup_name=${__db_master_name}-backup-$(date +%Y%m%d-%H%M%S)
      __output=$( aws rds create-db-instance-read-replica \
              --db-instance-identifier "$__db_backup_name" \
              --source-db-instance-identifier "$__db_master_name" \
              --db-instance-class "$__db_instance_type" )
      _error_code=$?
      __MSG="Command: tcctl aws create backup read replica: $__db_backup_name"
      __MSG+="$__output"
      if [ "$_error_code" -eq "0" ]; then
        _message "$__MSG"
        __db_url_suffix=$(grep "^DB_HOST=" .env | awk -F'.' '{ print $2"."$3"."$4"."$5"."$6 }')
        slack chat send "New DB slave: ${__db_backup_name}.${__db_url_suffix}" "#replica-db-access" > /dev/null
      else
        _message "$__MSG" "error" "$_error_code"
      fi
    fi
  done
}

if [ -z "$DB_MASTER_NAME" ]; then
  __MSG="Command: tcctl aws create_master_replicas missed --db-master-name"
  _message "$__MSG" "error" "$_error_code"
elif [ -z "$DB_INSTANCE_TYPE" ]; then
  __MSG="Command: tcctl aws create_master_replicas missed --db-instance-type"
  _message "$__MSG" "error" "$_error_code"
elif [ -z "$REPLICA_DB_INSTANCES_COUNT" ]; then
  __MSG="Command: tcctl aws create_master_replicas missed --replicas-count"
  _message "$__MSG" "error" "$_error_code"
else
  create_master_replicas "$DB_MASTER_NAME" "$DB_INSTANCE_TYPE" "$REPLICA_DB_INSTANCES_COUNT"
fi
